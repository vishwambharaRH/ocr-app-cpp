name: Build Qt C++ App (CI)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config git ca-certificates \
            libssl-dev libtiff5-dev libjpeg-dev zlib1g-dev libpng-dev \
            tesseract-ocr libleptonica-dev qt6-base-dev qt6-declarative-dev qt6-quickcontrols2-6-dev qt6-tools-dev

      - name: Setup dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install cmake pkg-config qt@6 tesseract openssl
          echo "::add-path::$(brew --prefix qt@6)/bin"

      - name: Configure CMake
        env:
          # On macOS, point CMake to Homebrew Qt; on Linux system packages should be in default search path
          CMAKE_PREFIX_PATH: ${{ runner.os == 'macOS' && ("$(brew --prefix qt@6)/lib/cmake") || '' }}
        run: |
          # Export compile_commands.json so clang-tidy can run
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            ${CMAKE_PREFIX_PATH:+-DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH"}

      - name: Build
        run: cmake --build build --config Release -- -j$(nproc || sysctl -n hw.ncpu)

      - name: Install clang-tidy (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy

      - name: Install clang-tidy (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install llvm
          # ensure brew llvm tools are on PATH for this step
          echo "::add-path::$(brew --prefix llvm)/bin"

      - name: Run clang-tidy
        run: |
          set -e
          if [ ! -f build/compile_commands.json ]; then
            echo "No compile_commands.json found; skipping clang-tidy"
            exit 0
          fi
          # Prefer clang-tidy from environment (brew llvm on macOS or apt on Ubuntu)
          CLANG_TIDY_BIN=clang-tidy
          if ! command -v ${CLANG_TIDY_BIN} >/dev/null 2>&1; then
            echo "clang-tidy not installed; skipping"
            exit 0
          fi
          # Run clang-tidy across C++ source files and treat warnings as errors.
          # Adjust -checks as needed for your codebase.
          SRC_FILES=$(find src tests -name '*.cpp' -or -name '*.cxx' -or -name '*.cc' | tr '\n' ' ')
          if [ -z "${SRC_FILES// }" ]; then
            echo "No source files found for clang-tidy"
            exit 0
          fi
          echo "Running clang-tidy on: ${SRC_FILES}"
          # NOTE: clang-tidy can be noisy; configure checks to your policy. Here we enable common analyzers.
          for f in ${SRC_FILES}; do
            echo "---- lint: $f ----"
            ${CLANG_TIDY_BIN} -p build -warnings-as-errors='*' -checks='-*,clang-analyzer-*,modernize-*,performance-*,readability-*' "$f"
          done

      - name: Run basic smoke (optional)
        run: |
          # If the binary exists, run it with --help or print version; don't fail CI if interactive UI
          if [ -x build/QtQuickTessApp.app/Contents/MacOS/QtQuickTessApp ]; then
            build/QtQuickTessApp.app/Contents/MacOS/QtQuickTessApp --version || true
          elif [ -x build/QtQuickTessApp ]; then
            build/QtQuickTessApp --version || true
          else
            echo "No runnable binary found (UI builds are OK)."
          fi

      - name: Run unit tests
        run: |
          if [ -d build ]; then
            cmake --build build --target test || true
            ctest --test-dir build --output-on-failure || true
          else
            echo "No build directory found; skipping tests"
          fi

      - name: Package artifacts
        run: |
          set -e
          mkdir -p packaged
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            if [ -d build/QtQuickTessApp.app ]; then
              ZIPNAME="QtQuickTessApp-macos-${{ github.run_number }}.zip"
              ditto -c -k --sequesterRsrc --keepParent build/QtQuickTessApp.app packaged/${ZIPNAME}
              echo "Created packaged/${ZIPNAME}"
            else
              echo "No .app bundle found to package"
            fi
          else
            # Linux: package the built binary or the entire build folder
            if [ -x build/QtQuickTessApp ]; then
              TARNAME="QtQuickTessApp-linux-${{ github.run_number }}.tar.gz"
              tar -C build -czf packaged/${TARNAME} QtQuickTessApp
              echo "Created packaged/${TARNAME}"
            else
              # Fallback: archive build directory
              TARNAME="QtQuickTessApp-build-${{ github.run_number }}.tar.gz"
              tar -C build -czf packaged/${TARNAME} .
              echo "Created packaged/${TARNAME}"
            fi
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-app-build-${{ matrix.os }}
          path: |
            build/QtQuickTessApp.app
            build/QtQuickTessApp
            packaged

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: cpp

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v2


      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-app-build-${{ matrix.os }}
          path: |
            build/QtQuickTessApp.app
            build/QtQuickTessApp
